<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>自炊メニュールーレット</title>
    <style>
        /* スタイルは前回と同じですが、読み込み中の表示を追加しています */
        body {
            font-family: 'Helvetica Neue', Arial, sans-serif;
            background-color: #f0f2f5;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            margin: 0;
            overflow: hidden;
        }
        h1 { color: #333; margin-bottom: 20px; font-size: 1.5rem; }
        .wheel-container {
            position: relative;
            width: 300px;
            height: 300px;
            margin-bottom: 30px;
        }
        canvas {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
            transition: transform 4s cubic-bezier(0.25, 0.1, 0.25, 1);
        }
        .pointer {
            position: absolute;
            top: -10px;
            left: 50%;
            transform: translateX(-50%);
            width: 0;
            height: 0;
            border-left: 15px solid transparent;
            border-right: 15px solid transparent;
            border-top: 25px solid #ff4757;
            z-index: 10;
        }
        .controls {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px;
        }
        button {
            background-color: #2ed573;
            color: white;
            border: none;
            padding: 15px 40px;
            font-size: 1.2rem;
            font-weight: bold;
            border-radius: 50px;
            cursor: pointer;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        button:disabled { background-color: #ccc; cursor: not-allowed; }
        .result {
            margin-top: 20px;
            font-size: 1.5rem;
            font-weight: bold;
            color: #333;
            min-height: 1.5em;
        }
        .loading {
            color: #666;
            font-size: 0.9rem;
        }
    </style>
</head>
<body>

    <h1>今日の献立は...？</h1>

    <div class="wheel-container">
        <div class="pointer"></div>
        <canvas id="wheelCanvas" width="500" height="500"></canvas>
    </div>

    <div class="result" id="resultText"></div>

    <div class="controls">
        <button id="spinBtn" onclick="spin()" disabled>読み込み中...</button>
        <div id="statusMsg" class="loading">スプレッドシートからメニューを取得しています...</div>
        
        <a href="https://docs.google.com/spreadsheets" target="_blank" style="font-size:0.8rem; color:#999; text-decoration:none;">
            [管理者用] メニューを編集する
        </a>
    </div>

    <script>
        // ==========================================
        // ↓↓↓ ここに「公開したCSVのURL」を貼ってください ↓↓↓
        const SHEET_CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vS9vcpgJamGRKg4euxd_i53o_fMAYU4BSP5KLozymwX6Dz5RRYOrJBU_Z8s5pRYxp7rTo_QmPVyakNj/pub?output=csv'; 
        // ==========================================

        let items = []; // スプレッドシートから読み込んだデータをここに入れます
        const canvas = document.getElementById('wheelCanvas');
        const ctx = canvas.getContext('2d');
        const spinBtn = document.getElementById('spinBtn');
        const resultText = document.getElementById('resultText');
        const statusMsg = document.getElementById('statusMsg');

        let currentAngle = 0;
        let isSpinning = false;
        const colors = ['#FF6B6B', '#4ECDC4', '#45B7D1', '#FFA07A', '#98D8C8', '#F7DC6F', '#BB8FCE'];

        // 起動時にスプレッドシートを読みに行く
        async function loadMenu() {
            try {
                const response = await fetch(SHEET_CSV_URL);
                if (!response.ok) throw new Error('Network response was not ok');
                
                const text = await response.text();
                
                // CSVを配列に変換（改行で区切る）
                const rows = text.split('\n').map(row => row.trim());
                
                // 1行目はヘッダー（「メニュー」などの文字）と仮定して削除してもいいですが、
                // 今回は「空行」と「重複」を削除するだけにします
                // 1行目のヘッダーを除外したい場合は .slice(1) を使います
                
                // 重複排除セット
                const uniqueItems = new Set();
                
                rows.forEach(row => {
                    // カンマが含まれている場合の簡易処理（今回は単純なリスト想定）
                    const cleanRow = row.replace(/['"]+/g, ''); 
                    if (cleanRow && cleanRow !== "メニュー") { // "メニュー"という文字は除外
                        uniqueItems.add(cleanRow);
                    }
                });

                items = Array.from(uniqueItems);

                if (items.length < 2) {
                    statusMsg.innerText = "データ不足: スプレッドシートにメニューを2つ以上書いてください";
                    return;
                }

                drawWheel();
                spinBtn.disabled = false;
                spinBtn.innerText = "START";
                statusMsg.innerText = `メニュー数: ${items.length}品`;

            } catch (error) {
                console.error(error);
                statusMsg.innerText = "エラー: データの読み込みに失敗しました。URLを確認してください。";
            }
        }

        function drawWheel() {
            const arc = 2 * Math.PI / items.length;
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            const radius = canvas.width / 2;
            const centerX = canvas.width / 2;
            const centerY = canvas.height / 2;

            items.forEach((item, i) => {
                const angle = i * arc;
                ctx.beginPath();
                ctx.fillStyle = colors[i % colors.length];
                ctx.moveTo(centerX, centerY);
                ctx.arc(centerX, centerY, radius, angle, angle + arc);
                ctx.fill();
                ctx.save();
                ctx.translate(centerX, centerY);
                ctx.rotate(angle + arc / 2);
                ctx.textAlign = "right";
                ctx.fillStyle = "#fff";
                ctx.font = "bold 18px Helvetica";
                ctx.fillText(item, radius - 20, 10);
                ctx.restore();
            });
        }

        function spin() {
            if (isSpinning) return;
            isSpinning = true;
            resultText.innerText = "";
            spinBtn.disabled = true;

            const spinAngle = Math.random() * 2000 + 3000; 
            currentAngle += spinAngle;
            canvas.style.transform = `rotate(-${currentAngle}deg)`;

            setTimeout(() => {
                isSpinning = false;
                spinBtn.disabled = false;
                const degrees = currentAngle % 360;
                const arc = 360 / items.length;
                const index = Math.floor((360 - degrees + 90) % 360 / arc); 
                const winner = items[index >= items.length ? 0 : index]; 
                resultText.innerText = "今夜は「" + winner + "」に決定！";
            }, 4000);
        }

        // 実行開始
        loadMenu();

    </script>
</body>
</html>
